# Pay402 - Cursor AI Rules

## üóÇÔ∏è Source of Truth Hierarchy

**When in doubt, trust this order:**
1. **Code in `Pay402/`** - What actually works (ultimate truth)
2. **Docs in `Pay402/docs/`** - Architecture, dev guide (authoritative)
3. **`HackMoney_Research/`** - Exploration notes (STALE after Jan 31)

**Rule:** If research docs conflict with Pay402 code/docs, Pay402 wins.

**Temporary Files Rule:**
- Handoff docs (e.g., `HANDOFF_*.md`) are temporary
- DELETE when phase is complete and content is documented in permanent docs
- If unsure: "Can I recreate this info from code + docs?" ‚Üí YES = delete

---

## üö® Rule #0: FIGHT BLOAT

### Documentation
- ONE topic = ONE file (single source of truth)
- Update IN PLACE (no v2, no summaries, no "updated" versions)
- Delete redundant files IMMEDIATELY
- Use git log for change history (not separate docs)

### Code
- Write MINIMAL code that works
- Delete unused code IMMEDIATELY (functions, imports, commented code)
- No "just in case" features (YAGNI)
- No premature abstraction (wait until needed 3 times)

### Testing
- Test EACH function BEFORE moving to next
- Add test BEFORE committing
- No "I'll test it later"

---

## üö® Rule #1: Hackathon Commits

**Commit every 30-60 minutes** - Judges verify work was done during event

**Commit when:**
- Complete a logical unit of work
- Before breaks
- After fixing bugs
- Switching components

**Commit format:**
```
<type>(<scope>): <subject>

Types: feat, fix, test, docs, chore, refactor
Examples:
  feat(move): add settle_payment function
  test(move): add coin split test
  fix(facilitator): handle missing coins
```

**Never:**
- Bulk commit 500 lines
- Commit untested code
- Commit "WIP" without working state

---

## üíª Tech Stack Rules

### TypeScript
- Strict mode enabled
- No `any` types (use `unknown`)
- async/await (not .then chains)

### Move
- Generic `Coin<T>` (not USDC-only)
- Use `&mut` for coins (prevent front-running)
- Emit events for state changes
- Ephemeral receipts (zero storage)
- **Testing:** Use `expected_failure(abort_code=X, location=module)` for framework errors

### Token Usage (CRITICAL)
- **SUI is ONLY for gas** - Never use as payment token on testnet
- **USDC is for payments** - Default token for all payment flows
- **Localnet:** Test freely with unlimited faucet
- **Testnet:** Very limited SUI supply (need to preserve for gas sponsorship)
- **Testnet USDC supply:** ~20 USDC available - use small amounts for testing (0.01-0.10 USDC)
- **Testing strategy:** Develop on localnet, verify on testnet sparingly
- All examples, tests, and docs should use USDC as payment token
- Coin type: `0xa1ec7fc00a6f40db9693ad1415d0c193ad3906494428cf252621037bd7117e29::usdc::USDC`
- Test amounts: 10000-100000 micro-USDC (0.01-0.10 USDC) per transaction

### Security
- Never log private keys
- Validate all inputs
- Use nonces (prevent replay)
- Token expiration (5 min)

---

## üìÅ File Structure

```
move/payment/              - Move contract
facilitator/src/           - Backend API (TypeScript)
widget/src/                - Frontend (React + TypeScript)
demo/                      - Demo page
docs/                      - Architecture, dev guide only
```

---

## üß™ Development Workflow

1. **Local first** - Test on local SUI network
2. **Incremental** - Build one function at a time
3. **Test immediately** - Write test, run test, then commit
4. **Testnet last** - Only when local works

Example:
```bash
# Write function
vim payment.move

# Write test
vim payment_tests.move

# Run test
sui move test

# Commit (only if test passes!)
git commit -m "feat(move): add settle_payment with test"
```

---

## ‚úÖ Pre-Commit Checklist

- [ ] Code compiles/runs
- [ ] Tests pass
- [ ] No console errors
- [ ] No TODOs (fix or remove)
- [ ] No commented code (delete it)
- [ ] No secrets (keys, .env)
- [ ] Descriptive commit message

---

## üéØ Priorities

**Must Have:**
- Move contract with Coin<T>
- Facilitator balance + payment endpoints
- zkLogin integration
- Basic widget UI
- Demo with x402 Echo

**Defer:**
- Payment channels
- CCTP integration (show diagram only)
- AI agent mode (mention only)
- Analytics, dashboards

---

**Target: 50-100+ commits in 2-day hackathon**

See `docs/DEVELOPMENT_GUIDE.md` for detailed workflow.

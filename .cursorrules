# Pay402 Cursor Rules

## Anti-Bloat

- Do work directly, commit with detailed message
- NO analysis/audit/plan/status markdown files
- Present findings in chat, not files
- DELETE temporary docs after user reads them

## Testing Levels

**Move:** payment*tests.move → `sui move test` in move/payment/
**TS Facilitator:** src/**tests**/*.test.ts → `npm test` (vitest, Node.js)
**TS Widget:** src/lib/\_.test.ts → `npm test` (vitest + jsdom for browser)
**Integration:** scripts/smoke-test.sh (all services)

## Tech Stack (verify in package.json first!)

**Facilitator:** @mysten/sui (gRPC), Express, TypeScript
**Merchant:** jose (Ed25519 JWT), Express, JavaScript
**Widget:** React, Vite, custom PTB verifier
❌ NO Bull queue, NO @x402/fetch package

## Directory Structure

**Move:** move/payment/ (NOT contracts/)
**Controllers:** src/controllers/ (NOT src/api/)
**Tests:** src/**tests**/ and scripts/

## Debugging Protocol: CHECK LOGS FIRST

**MANDATORY SEQUENCE when debugging:**

1. Read logs BEFORE guessing (facilitator: /tmp/facilitator.log or terminal)
2. Read FULL error context (stack, request/response, data shapes)
3. Inspect actual API responses in logs before changing code
4. Never assume data formats - log them and verify

**If error persists >2 attempts → READ THE LOGS**

## Common Traps We Hit

- Widget tests need jsdom (browser env), not plain Node.js
- localnet_proxy: NO gRPC support (use direct :9000)
- PTB fixtures: Expire in 5min, regenerate via scripts/generate-test-ptbs.js
- Mock PTBs: Unreliable, always use real fixtures from live services
- Check package.json before claiming dependencies exist
- Active address must be funded: `sui client active-address`
- Don't create analysis docs when analyzing (ironic bloat!)

## Per-Component Docs

Each component (facilitator/, merchant/, widget/):

- ONE README.md only (setup + API + troubleshooting)
- NO status docs, NO implementation-complete docs
- Testing covered in root docs/development/TESTING.md

## Commit Discipline

- Batch related changes, run `git status` first
- Clear messages with metrics (files changed, KB saved, impact)
- Commits are documentation (explain what + why)

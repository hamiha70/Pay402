# Pay402 Cursor Rules

## Anti-Bloat

- Do work directly, commit with detailed message
- NO analysis/audit/plan/status markdown files
- NO progress tracking docs (use git commits instead)
- Present findings in chat, not files
- DELETE temporary docs after user reads them
- Progress tracking: git commits (history) + strategic plan (high-level) + code comments (details)

## Testing Standards

**ALWAYS USE VITEST** - No Jest, no other test frameworks

**NO SKIPPING TESTS** - All tests must pass, use mocks/fixtures instead of skip/try-catch

**Test Locations:**

- Move: `move/payment/tests/payment_tests.move` → `lsui move test` (IMPORTANT: Kill all Sui network processes first!)
- Facilitator: `src/__tests__/*.test.ts` → `npm test` (vitest, Node.js env)
- Widget: `src/__tests__/*.test.ts` → `npm test` (vitest, jsdom env)
- Integration: `scripts/test-*.sh` (end-to-end with all services)

**Move Test Requirements:**

- STOP localnet before running `lsui move test` (otherwise sui config conflict occurs)
- Use `lsui` (not `sui`) for localnet-specific operations
- Restart localnet after tests: `localnet start`

**Test Commands:**

- `npm test` - Run all tests once
- `npm run test:watch` - Watch mode (TDD)
- `npm run test:ui` - Visual UI for debugging
- `npm run test:coverage` - Coverage report (70% minimum)

**Test Structure:**

- Unit tests: Test individual functions/components (use mocks for blockchain)
- Integration tests: Test API endpoints and flows (use test fixtures)
- E2E tests: Test complete user journeys with browser automation (funded addresses)

**Test Best Practices:**

- NEVER skip tests with `.skip()` or try-catch expecting failures
- Mock blockchain calls in unit tests (avoid gas selection failures)
- Use real funded addresses only in E2E/integration tests
- All assertions must be meaningful - no "expect error or success"

## Tech Stack (verify in package.json first!)

**Facilitator:** @mysten/sui (gRPC), Express, TypeScript, **Vitest**
**Merchant:** jose (Ed25519 JWT), Express, JavaScript
**Widget:** React, Vite, custom PTB verifier, **Vitest**
**Testing:** Vitest ONLY (never Jest, Mocha, or others)
❌ NO Bull queue, NO @x402/fetch package, ❌ NO Jest

## Code Architecture: Isomorphic JavaScript

**CRITICAL PRINCIPLE:** Write code that runs in BOTH Node.js AND browser environments

**✅ ALLOWED (Universal APIs):**

- `fetch()` (native in Node.js 18+, browsers)
- `FormData`, `Headers`, `Request`, `Response` (native in both)
- `URL`, `URLSearchParams` (standard in both)
- `Uint8Array`, `Array`, `Object`, `Map`, `Set` (standard JavaScript)
- `@mysten/sui` SDK (works in both environments)
- ESM imports: `import/export` (NOT CommonJS `require()`)

**❌ FORBIDDEN in shared code:**

- Browser-only: `window`, `document`, `localStorage`, `navigator`
- Node.js-only: `Buffer`, `fs`, `path`, `process.env` (use config instead)
- `atob()`/`btoa()` - use polyfill or `Buffer.from(str, 'base64')` for Node.js

**Shared Code Locations:**

- `widget/src/lib/` - Browser-compatible payment logic (used by widget UI and facilitator e2e tests)
- `facilitator/src/utils/` - Node.js utilities that can be reused across backend services

**Critical Shared Utilities:**

- `facilitator/src/utils/digest.ts` - Transaction digest calculation (getTransactionDigest)
  - Used by: facilitator backend (optimistic mode), e2e tests, any client needing digest
  - NEVER duplicate digest logic - always import from this module

**Why:** Widget UI and facilitator e2e tests must use IDENTICAL logic to ensure tests predict production behavior. Any divergence = false confidence. Backend utilities must be centralized to avoid implementation drift.

## Directory Structure

**Move:** move/payment/ (NOT contracts/)
**Controllers:** src/controllers/ (NOT src/api/)
**Tests:** src/**tests**/ and scripts/

## Debugging Protocol: CHECK LOGS FIRST

**MANDATORY SEQUENCE when debugging:**

1. Read logs BEFORE guessing (facilitator: /tmp/facilitator.log or terminal)
2. Read FULL error context (stack, request/response, data shapes)
3. Inspect actual API responses in logs before changing code
4. Never assume data formats - log them and verify

**If error persists >2 attempts → READ THE LOGS**

## Common Traps We Hit

- **ALWAYS use Vitest** (never Jest) - check imports: `from 'vitest'` not `from '@jest/globals'`
- Widget tests need jsdom (browser env), facilitator tests use Node env
- localnet_proxy: NO gRPC support (use direct :9000)
- PTB fixtures: Expire in 5min, regenerate via scripts/generate-test-ptbs.js
- Mock PTBs: Unreliable, always use real fixtures from live services
- Check package.json before claiming dependencies exist
- Active address must be funded: `sui client active-address`
- Don't create analysis docs when analyzing (ironic bloat!)
- Test coverage minimum: 70% (lines, functions, branches, statements)

## Per-Component Docs

Each component (facilitator/, merchant/, widget/):

- ONE README.md only (setup + API + troubleshooting)
- NO status docs, NO implementation-complete docs
- Testing covered in root docs/development/TESTING.md

## Commit Discipline

- Batch related changes, run `git status` first
- Clear messages with metrics (files changed, KB saved, impact)
- Commits are documentation (explain what + why)

# Pay402 Cursor Rules

## Anti-Bloat

- Do work directly, commit with detailed message
- NO analysis/audit/plan/status markdown files
- Present findings in chat, not files
- DELETE temporary docs after user reads them

## Testing Standards

**ALWAYS USE VITEST** - No Jest, no other test frameworks

**Test Locations:**

- Move: `move/payment/tests/payment_tests.move` → `sui move test`
- Facilitator: `src/__tests__/*.test.ts` → `npm test` (vitest, Node.js env)
- Widget: `src/__tests__/*.test.ts` → `npm test` (vitest, jsdom env)
- Integration: `scripts/test-*.sh` (end-to-end with all services)

**Test Commands:**

- `npm test` - Run all tests once
- `npm run test:watch` - Watch mode (TDD)
- `npm run test:ui` - Visual UI for debugging
- `npm run test:coverage` - Coverage report (70% minimum)

**Test Structure:**

- Unit tests: Test individual functions/components
- Integration tests: Test API endpoints and flows
- E2E tests: Test complete user journeys with browser automation

## Tech Stack (verify in package.json first!)

**Facilitator:** @mysten/sui (gRPC), Express, TypeScript, **Vitest**
**Merchant:** jose (Ed25519 JWT), Express, JavaScript
**Widget:** React, Vite, custom PTB verifier, **Vitest**
**Testing:** Vitest ONLY (never Jest, Mocha, or others)
❌ NO Bull queue, NO @x402/fetch package, ❌ NO Jest

## Directory Structure

**Move:** move/payment/ (NOT contracts/)
**Controllers:** src/controllers/ (NOT src/api/)
**Tests:** src/**tests**/ and scripts/

## Debugging Protocol: CHECK LOGS FIRST

**MANDATORY SEQUENCE when debugging:**

1. Read logs BEFORE guessing (facilitator: /tmp/facilitator.log or terminal)
2. Read FULL error context (stack, request/response, data shapes)
3. Inspect actual API responses in logs before changing code
4. Never assume data formats - log them and verify

**If error persists >2 attempts → READ THE LOGS**

## Common Traps We Hit

- **ALWAYS use Vitest** (never Jest) - check imports: `from 'vitest'` not `from '@jest/globals'`
- Widget tests need jsdom (browser env), facilitator tests use Node env
- localnet_proxy: NO gRPC support (use direct :9000)
- PTB fixtures: Expire in 5min, regenerate via scripts/generate-test-ptbs.js
- Mock PTBs: Unreliable, always use real fixtures from live services
- Check package.json before claiming dependencies exist
- Active address must be funded: `sui client active-address`
- Don't create analysis docs when analyzing (ironic bloat!)
- Test coverage minimum: 70% (lines, functions, branches, statements)

## Per-Component Docs

Each component (facilitator/, merchant/, widget/):

- ONE README.md only (setup + API + troubleshooting)
- NO status docs, NO implementation-complete docs
- Testing covered in root docs/development/TESTING.md

## Commit Discipline

- Batch related changes, run `git status` first
- Clear messages with metrics (files changed, KB saved, impact)
- Commits are documentation (explain what + why)

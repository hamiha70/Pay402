#!/usr/bin/env node
/**
 * Generate Real PTB Test Fixtures
 * 
 * Uses the facilitator's build-ptb endpoint to create REAL PTBs
 * and saves them as fixtures for widget testing.
 */

const fs = require('fs');
const path = require('path');

const FACILITATOR_URL = 'http://localhost:3001';
const MERCHANT_URL = 'http://localhost:3002';
const FIXTURES_DIR = path.join(__dirname, '../widget/src/__fixtures__');

// Test buyer address (can be any valid SUI address for testing)
const BUYER_ADDRESS = '0xabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcdefabcd';

// Get real merchant config from merchant's health endpoint
async function getMerchantConfig() {
  const response = await fetch(`${MERCHANT_URL}/health`);
  if (!response.ok) {
    throw new Error('Merchant not running');
  }
  const data = await response.json();
  return {
    merchantAddress: data.config.merchantAddress,
    facilitatorAddress: data.config.facilitatorAddress,
    resourcePrice: data.config.resourcePrice,
    facilitatorFee: data.config.facilitatorFee,
    coinType: data.config.coinType,
  };
}

async function getMerchantJWT() {
  // Get real JWT from merchant's premium-data endpoint
  const response = await fetch(`${MERCHANT_URL}/api/premium-data`);
  
  if (response.status !== 402) {
    throw new Error(`Expected 402, got ${response.status}`);
  }
  
  const data = await response.json();
  return {
    invoiceJWT: data.invoice,
    invoice: data.invoiceData,
  };
}

async function buildPTB(invoiceJWT, buyerAddress) {
  const response = await fetch(`${FACILITATOR_URL}/build-ptb`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ invoiceJWT, buyerAddress }),
  });
  
  if (!response.ok) {
    throw new Error(`Failed to build PTB: ${response.status} ${await response.text()}`);
  }
  
  return await response.json();
}

async function generateFixtures() {
  console.log('ğŸ”§ Generating PTB test fixtures using REAL merchant keys...\n');

  // Get merchant config
  const config = await getMerchantConfig();
  console.log('Merchant config:', config);
  console.log('');

  // Create fixtures directory
  if (!fs.existsSync(FIXTURES_DIR)) {
    fs.mkdirSync(FIXTURES_DIR, { recursive: true });
  }

  const fixtures = {};

  // 1. Valid payment PTB (using REAL merchant JWT)
  console.log('1. Generating valid payment PTB from REAL merchant...');
  const { invoiceJWT: validJWT, invoice: validInvoice } = await getMerchantJWT();
  const validPTB = await buildPTB(validJWT, BUYER_ADDRESS);
  fixtures.validPayment = {
    invoice: validInvoice,
    invoiceJWT: validJWT,
    buyerAddress: BUYER_ADDRESS,
    ptbBytes: validPTB.ptbBytes,
    description: 'Valid payment PTB generated by real merchant with real keys',
  };
  console.log('   âœ… Valid payment PTB generated with REAL merchant signature\n');

  // 2. Another valid PTB for comparison
  console.log('2. Generating second valid PTB for comparison...');
  const { invoiceJWT: validJWT2, invoice: validInvoice2 } = await getMerchantJWT();
  const validPTB2 = await buildPTB(validJWT2, BUYER_ADDRESS);
  fixtures.validPayment2 = {
    invoice: validInvoice2,
    invoiceJWT: validJWT2,
    buyerAddress: BUYER_ADDRESS,
    ptbBytes: validPTB2.ptbBytes,
    description: 'Second valid payment for testing different nonces',
  };
  console.log('   âœ… Second valid payment PTB generated\n');

  // Save fixtures
  const outputPath = path.join(FIXTURES_DIR, 'ptb-fixtures.json');
  fs.writeFileSync(outputPath, JSON.stringify(fixtures, null, 2));
  
  console.log(`âœ… Fixtures saved to: ${outputPath}`);
  console.log(`\nGenerated ${Object.keys(fixtures).length} PTB fixtures:`);
  Object.keys(fixtures).forEach(key => {
    console.log(`   - ${key}: ${fixtures[key].description}`);
  });
  console.log('\nğŸ’¡ These fixtures use the REAL merchant private key from merchant/.env');
  console.log('   So they will work with the actual widget verification!');
}

// Run
(async () => {
  try {
    // Check if facilitator is running
    const health = await fetch(`${FACILITATOR_URL}/health`);
    if (!health.ok) {
      throw new Error('Facilitator not running');
    }
    
    await generateFixtures();
  } catch (error) {
    console.error('âŒ Error:', error.message);
    console.error('\nğŸ’¡ Make sure facilitator is running: cd facilitator && npm run dev');
    process.exit(1);
  }
})();
